<!DOCTYPE html>
<meta charset="utf-8">
<html>
<head>
  <!-- no favicon -->
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <script type="text/javascript">
  function getAudioFile(audioCtx, audioElement, url) {
    source = audioCtx.createBufferSource();
    var request = new XMLHttpRequest();

    request.open('GET', url, true);

    request.responseType = 'blob';

    request.onload = function(e) {
        var blob = this.response;
        var fileReader = new FileReader();
        fileReader.onload = function() {
            var arrayBuffer = this.result;

            audioCtx.decodeAudioData(arrayBuffer, function(audioBuffer) {
                source.buffer = audioBuffer;

                //source.connect(audioCtx.destination);
                //source.loop = true;
              },
              function(e){ console.log("Error with decoding audio data" + e.err); }
            );
        };
        fileReader.readAsArrayBuffer(blob);
        audioElement.src = window.URL.createObjectURL(blob);
    }

    request.send();

    return source;
  }

  window.onload = function(){
    const url = "music/surf_mesa_ily.mp3";
    var audio = new Audio();
    audio.controls = true;
    audio.loop = false;
    audio.autoplay = false;
    audio.muted = false;
    document.getElementById("audio").appendChild(audio);

    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioContext = new AudioContext();
    const track = getAudioFile(audioContext, audio, url);
    const analyser = audioContext.createAnalyser();
    analyser.fftSize = 2048;

    track.connect(analyser);
    analyser.connect(audioContext.destination);

  }
  </script>
</head>
<body>
<div id="audio"></div>
</body>
</html>
